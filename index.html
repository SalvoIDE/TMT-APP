<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trail Making Test ‚Äî Windows Offline Edition</title>
<style>
body {background:#111827;color:#fff;font-family:sans-serif;text-align:center;margin:0;overflow:hidden;}
.hidden {display:none;}
button {background:#1f2937;color:#fff;border:1px solid #fff;border-radius:8px;padding:10px 20px;margin:10px;font-size:18px;cursor:pointer;}
canvas {background:#111827;display:block;margin:0 auto;touch-action:none;}
input[type="text"] {font-size:18px;padding:5px;margin:10px;border-radius:5px;border:none;}
label {font-size:18px;}
h1,h2,p {margin:10px;}
</style>
</head>
<body>
<div id="home">
  <h1>Trail Making Test ‚Äî Windows Offline Edition</h1>
  <p><label>Participant ID: <input id="pid" type="text" placeholder="P01"></label></p>
  <p><label><input id="showErrors" type="checkbox" checked> Show errors (visual feedback)</label></p>
  <button id="selectFolderBtn">Select Folder for Saving</button>
  <p id="folderPath" style="font-size:14px;color:#9ca3af;"></p>
  <button id="startBtn">Start Session</button>
</div>

<div id="test" class="hidden">
  <h2 id="taskTitle"></h2>
  <canvas id="canvas"></canvas>
</div>

<div id="message" class="hidden"><h2 id="msgText"></h2></div>

<div id="endScreen" class="hidden">
  <h2>End of the test</h2>
  <button id="returnHomeBtn">Return to Home</button>
</div>

<script>
(async function(){
  const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d");
  const home=document.getElementById("home"),test=document.getElementById("test"),msg=document.getElementById("message"),msgText=document.getElementById("msgText");
  const startBtn=document.getElementById("startBtn"),selectFolderBtn=document.getElementById("selectFolderBtn"),folderPath=document.getElementById("folderPath");
  const title=document.getElementById("taskTitle"),showErrors=document.getElementById("showErrors");
  const endScreen=document.getElementById("endScreen"),returnHomeBtn=document.getElementById("returnHomeBtn");

  let pid="",currentTask=0,tasks=["PracticeA","TMT-A","PracticeB","TMT-B"];
  let nodes=[],path=[],current=0,startTime=null,log=[],done=false,saveDirHandle=null;
  let baseLayout=[];

  // Base logical size for scaling
  const BASE_WIDTH = 1920;
  const BASE_HEIGHT = 1080;

  // Layouts (fixed for all participants, defined for 1920√ó1080 logical space)
  const layouts={
    "PracticeA":[{l:"1",x:300,y:900},{l:"2",x:600,y:750},{l:"3",x:900,y:800},{l:"4",x:1200,y:600},{l:"5",x:1450,y:700},{l:"6",x:1650,y:500},{l:"7",x:1300,y:350},{l:"8",x:900,y:250}],
    "TMT-A":[{l:"1",x:200,y:900},{l:"2",x:400,y:800},{l:"3",x:700,y:850},{l:"4",x:900,y:650},{l:"5",x:1150,y:700},{l:"6",x:1450,y:500},{l:"7",x:1700,y:600},{l:"8",x:1650,y:400},{l:"9",x:1400,y:300},{l:"10",x:1100,y:450},{l:"11",x:850,y:400},{l:"12",x:600,y:300},{l:"13",x:350,y:350},{l:"14",x:400,y:150},{l:"15",x:700,y:200},{l:"16",x:1000,y:150},{l:"17",x:1300,y:250},{l:"18",x:1550,y:150},{l:"19",x:1750,y:350},{l:"20",x:1500,y:450},{l:"21",x:1200,y:350},{l:"22",x:950,y:300},{l:"23",x:650,y:200},{l:"24",x:400,y:250},{l:"25",x:250,y:150}],
    "PracticeB":[{l:"1",x:300,y:900},{l:"A",x:600,y:750},{l:"2",x:900,y:800},{l:"B",x:1200,y:600},{l:"3",x:1450,y:700},{l:"C",x:1650,y:500},{l:"4",x:1300,y:350},{l:"D",x:900,y:250}],
    "TMT-B":[{l:"1",x:250,y:900},{l:"A",x:500,y:850},{l:"2",x:400,y:650},{l:"B",x:800,y:700},{l:"3",x:950,y:500},{l:"C",x:400,y:450},{l:"4",x:1200,y:400},{l:"D",x:1550,y:500},{l:"5",x:1450,y:700},{l:"E",x:1000,y:850},{l:"6",x:700,y:400},{l:"F",x:300,y:300},{l:"7",x:500,y:200},{l:"G",x:800,y:250},{l:"8",x:1000,y:150},{l:"H",x:1300,y:250},{l:"9",x:1600,y:300},{l:"I",x:1700,y:450},{l:"10",x:1800,y:600},{l:"J",x:1600,y:800},{l:"11",x:1200,y:900},{l:"K",x:850,y:950},{l:"12",x:600,y:950},{l:"L",x:400,y:900},{l:"13",x:1800,y:950}]};

  // üîß Simple scaling: keep proportions constant
  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const scale = Math.min(canvas.width / BASE_WIDTH, canvas.height / BASE_HEIGHT);
    nodes = baseLayout.map(p => ({
      x: p.x * scale + (canvas.width - BASE_WIDTH * scale) / 2,
      y: p.y * scale + (canvas.height - BASE_HEIGHT * scale) / 2,
      l: p.l,
      r: 30 * scale
    }));
    draw();
  }

  // üñäÔ∏è Draw nodes and paths
  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(path.length>1){
      ctx.beginPath();ctx.lineWidth=3;ctx.strokeStyle="#fff";
      ctx.moveTo(path[0].x,path[0].y);
      for(let i=1;i<path.length;i++)ctx.lineTo(path[i].x,path[i].y);
      ctx.stroke();
    }
    ctx.textAlign="center";ctx.textBaseline="middle";ctx.lineWidth=2;
    ctx.font=Math.floor(canvas.width/35)+"px Arial";
    for(let n of nodes){
      ctx.fillStyle="#111827";ctx.strokeStyle="#fff";
      ctx.beginPath();ctx.arc(n.x,n.y,n.r,0,2*Math.PI);ctx.fill();ctx.stroke();
      ctx.fillStyle="#fff";ctx.fillText(n.l,n.x,n.y);
    }
    if(nodes.length>0){
      const first=nodes[0],last=nodes[nodes.length-1];
      ctx.font=Math.floor(canvas.width/45)+"px Arial";ctx.fillStyle="#fff";
      ctx.fillText("Begin",first.x,first.y-first.r*1.8);
      ctx.fillText("End",last.x,last.y-last.r*1.8);
    }
  }

  // üìÅ Select folder for saving
  async function selectFolder(){
    try{
      saveDirHandle=await window.showDirectoryPicker();
      folderPath.textContent="Saving to: "+saveDirHandle.name;
    }catch(e){alert("Folder access was cancelled or not supported.");}
  }

  // ‚ñ∂Ô∏è Start task
  function startTask(){
    const taskName=tasks[currentTask];
    title.textContent=taskName;
    home.classList.add("hidden");
    test.classList.remove("hidden");
    msg.classList.add("hidden");
    nodes=[];path=[];current=0;startTime=null;log=[];done=false;
    baseLayout=layouts[taskName];
    resize();
  }

  function nextExpected(){return nodes[current].l;}

  // üëÜ Tap/Click detection
  function tap(e){
    if(done)return;
    const rect=canvas.getBoundingClientRect();
    const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
    const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
    const now=Date.now();
    for(let n of nodes){
      const dx=n.x-x,dy=n.y-y;
      if(Math.sqrt(dx*dx+dy*dy)<n.r){
        const exp=nextExpected();
        if(n.l===exp){
          if(!startTime)startTime=now;
          const delta=log.length?(now-log[log.length-1].t_rel):0;
          log.push({ts:new Date().toISOString(),event:"click",elapsed:now-startTime,participant:pid,task:tasks[currentTask],index:current+1,label:n.l,expected:exp,x:Math.round(x),y:Math.round(y),delta_ms:delta,t_rel:now});
          path.push({x:n.x,y:n.y});current++;draw();
          if(current>=nodes.length){done=true;setTimeout(showSave,400);} 
        } else {
          log.push({ts:new Date().toISOString(),event:"error",participant:pid,task:tasks[currentTask],clicked:n.l,expected:exp});
          if(showErrors.checked){
            ctx.beginPath();ctx.arc(n.x,n.y,n.r,0,2*Math.PI);ctx.fillStyle="#b91c1c";ctx.fill();ctx.stroke();
            setTimeout(draw,250);
          }
        }
        break;
      }
    }
  }

  async function showSave(){
    log.push({ts:new Date().toISOString(),event:"completed",participant:pid,task:tasks[currentTask]});
    await saveResults();
  }

  async function saveResults(){
    const task=tasks[currentTask];
    const dateStr=new Date().toISOString().split("T")[0];
    const base=`${pid}_${task}_${dateStr}`;
    const csv=createCSV(),txt=createTXT(),json=createJSON();
    if(saveDirHandle){
      await writeFile(saveDirHandle,base+".csv",csv);
      await writeFile(saveDirHandle,base+".txt",txt);
      await writeFile(saveDirHandle,base+".json",json);
    } else {
      downloadFile(csv,base+".csv","text/csv");
      downloadFile(txt,base+".txt","text/plain");
      downloadFile(json,base+".json","application/json");
    }
    setTimeout(()=>{nextTask();},2000);
  }

  async function writeFile(dirHandle,filename,contents){
    const fileHandle=await dirHandle.getFileHandle(filename,{create:true});
    const writable=await fileHandle.createWritable();
    await writable.write(contents);
    await writable.close();
  }

  function downloadFile(content,filename,type){
    const blob=new Blob([content],{type:type});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=filename;
    a.click();
  }

  function createCSV(){
    let csv="timestamp,event_type,elapsed_ms,participant_id,task,click_index,label,expected,x,y,delta_ms\n";
    log.forEach(o=>{csv+=[o.ts,o.event,o.elapsed,o.participant,o.task,o.index||"",o.label||"",o.expected||"",o.x||"",o.y||"",o.delta_ms||""].join(",")+"\n"});
    return csv;
  }

  function createTXT(){
    return log.map(o=>`${o.ts} | ${o.event} | ${o.participant} | ${o.task} | idx=${o.index||""} | ${o.label||""}->${o.expected||""} | Œî=${o.delta_ms||""}ms`).join("\n");
  }

  function createJSON(){
    return JSON.stringify(log,null,2);
  }

  function nextTask(){
    currentTask++;
    if(currentTask<tasks.length){
      msgText.textContent=`Next: ${tasks[currentTask]} starting...`;
      test.classList.add("hidden");
      msg.classList.remove("hidden");
      setTimeout(startTask,2000);
    } else {
      showEndScreen();
    }
  }

  function showEndScreen(){
    test.classList.add("hidden");
    endScreen.classList.remove("hidden");
  }

  returnHomeBtn.onclick=()=>{
    endScreen.classList.add("hidden");
    home.classList.remove("hidden");
  };

  selectFolderBtn.onclick=selectFolder;
  startBtn.onclick=()=>{
    pid=document.getElementById("pid").value||"P00";
    currentTask=0;
    startTask();
  };

  canvas.addEventListener("mousedown",tap);
  canvas.addEventListener("touchstart",tap);
})();
</script>
</body>
</html>
